# 单元测试

## 这次分享要达到的目标

- 快速上手编写单元测试用例

## 提纲

1. 单元测试是什么，如何写一个单元测试
2. 从如何写引出三点步骤
3. 测试单元指的什么-》mock介绍-》snapshot介绍
4. 实例展示（两个例子）
5. 辩证看待。unit test的成本、收益、局限性

## 草稿

今天给大家分享的内容是近期对单测框架jest的学习所得，希望能够让不了解jest的同学也能很快上手写用例。

这次分享有三个内容：

1. 了解jest 环境配置
2. 单测技巧
3. 例子展示

jest-CLI本身提供了一个很方便的指令，帮助生成一份默认的配置 `jest --init`，我们enow项目的配置文件如下，其中几个较为特殊的配置项有...

配置好了环境，下面就是真正去用。完成一个单元测试，需要这么几个步骤：
其中的关键是

1. 如何mock?
2. 怎么检验结果？

为什么需要mock?
mock的意义在于将测试单元独立处理，不受依赖项变动的干扰。
jest的mock功能非常好用，它允许我们Mock模块、函数、和计时器。以我们项目为例：Text组件的单测用例中我们import了三个模块，其中作为测试单元的TextElement本身依赖了大量的外部模块，但实际我们需要的只有enow-kernel模块中的`PureComponent`和`CommonProps`，我们可以通过mock模块的内容,来按需取用。

这里我准备了一个实例，给我们的enow-engine中enow-data-transform/DetailParser模块添加单元测试。源码是这个样子：【贴图】，简单解释代码 -》 介绍思路-》贴第一次报错-》分析原因； 接着往下走，遇到了file路径处理部分，可抽离。

现在我们拿到了测试单元的运行结果，我们如何检测这个结果是否符合预期？或者进一步来说，我们如何确定这个测试单元的运行过程是符合我们预期的？我们可以从几个角度去入手：

1. 代码的行为
2. 代码的执行结果

例如：

1. 组件的事件回调应该在事件触发时就响应
2. Quill2EN的测试用例中，我明确知道En2Quill的转换结果应该包含哪些字段，可以通过断言去测试。

关于结果可靠性的检验，jest提供了一种方式，snapshot, 对前端组件的测试非常有用。通过`toMatchSnapshot`方法，jest生成一份当前用例运行结果的快照，之后每次执行测试用例都会去检验快照是否发生了变化。我们Text组件的快照大概长这样：

我们一起努力，让单元测试在我们的团队落地

确定输入并运行，这里有个问题：我们该如何处理代码中的模块依赖和函数调用？我们实际上不关心所依赖的函数或模块在当前用例是否正确执行，我们在乎的只是它给我们的那个结果。答案是：Mock，通过mock我们实现自定义所依赖函数和模块的返回。
